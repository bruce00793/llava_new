# Epoch 13 训练状态记录（0.5辅助权重修复后）

## 📅 训练信息
- **训练目录**: `/home/cly/auto/llava_test/LLaVA/outputs/6x4090_20260207_155951/`
- **Checkpoint来源**: `/home/cly/auto/llava_test/LLaVA/outputs/6x4090_20260206_180145/checkpoint_epoch_12.pth`
- **修复内容**: 辅助损失权重从递增`[0.1, 0.2, 0.3, 0.4, 0.5, 0.6]`改为统一`[0.5, 0.5, 0.5, 0.5, 0.5, 0.5]`
- **记录时间**: 2026-02-07 17:24

## 📊 Epoch 13 训练结果

### 损失指标（Epoch 13 Summary）
```
loss_total: 35.9598 (Avg)
loss_aux_total: 306.0442 (Avg)
损失比例: 306.04 / 35.96 = 8.5倍 ⚠️（比修复前的4.6倍更差！）

主损失分解:
  loss_cls: 0.3651
  loss_pts: 6.4505
  loss_dir: 11.9087

辅助损失各层分布:
  Layer 0: cls=0.2639, pts=39.1078, dir=0.0934  (pts损失最高！)
  Layer 1: cls=0.2966, pts=26.2223, dir=18.4780
  Layer 2: cls=0.3421, pts=22.2543, dir=18.4093
  Layer 3: cls=0.3490, pts=12.6270, dir=17.1694
  Layer 4: cls=0.3604, pts=8.9475, dir=15.7220
  Layer 5: cls=0.3619, pts=8.2141, dir=15.2316
```

### 梯度稳定性
- **梯度警告总数**: 937次（Epoch 13共4689 steps，约20%的steps有警告）
- **梯度警告频率**: 仍然很高，但比Epoch 12的100%有所改善
- **梯度范围**: 1700-14140（仍然非常大）
- **典型梯度值**: 2500-9000
- **最大梯度**: 14140.87 (Step 4465)
- **最小梯度**: 1604.12 (Step 4600)

### 训练进度
- **Epoch 13**: ✅ 已完成训练，正在进行验证
- **总Steps**: 4689 steps
- **学习率**: qformer_backbone=2.3e-05, qformer_decoder=1.9e-04, qformer_projector=2.3e-04

## ⚠️ 关键问题

### 1. 辅助损失反而增加
- **修复前（Epoch 12）**: loss_aux_total = 167.5, 比例 = 4.6倍
- **修复后（Epoch 13）**: loss_aux_total = 306.0, 比例 = 8.5倍
- **结论**: 统一权重0.5反而让辅助损失翻倍！说明问题不在权重分配，而在**辅助损失本身过大**

### 2. 浅层损失异常高
- **Layer 0 pts损失**: 39.1（是Layer 5的4.8倍）
- **说明**: Q-Former输出的初始特征质量很差，导致decoder第0层就需要大幅修正

### 3. 梯度仍然爆炸
- 梯度值仍然在1000-14000范围
- grad_clip=35.0无法有效控制
- 说明模型权重可能已经"学坏"，需要更激进的措施

## 🔍 可能的原因分析

### 假设1: Checkpoint已损坏
- Epoch 12的checkpoint可能已经包含错误的权重模式
- 从损坏的checkpoint恢复，即使修复权重也无法恢复

### 假设2: Q-Former特征质量问题
- Scene tokens质量差 → decoder需要大幅修正 → 高损失
- 3D位置编码可能有问题
- 视觉特征到BEV的对齐可能失败

### 假设3: 学习率设置问题
- LoRA lr=1e-4可能太高
- Decoder lr=2e-4可能导致震荡
- 需要更小的学习率或更长的warmup

### 假设4: 架构深度问题
- 6层decoder可能太深
- 梯度传播困难
- 可能需要减少层数或使用残差连接

## 📝 下一步建议

### 方案A: 降低辅助权重到0.1（图片建议）
```python
aux_weights = [0.1, 0.1, 0.1, 0.1, 0.1, 0.1]  # 总权重0.6
```
- 预期: 辅助损失降到60-80
- 风险: 深层监督不足

### 方案B: 从头训练 + 多项修复
- 辅助权重: 0.3（折中）
- 降低学习率: LoRA=5e-5, Decoder=1e-4
- 增大warmup: 2000 steps
- 更强grad_clip: 10.0

### 方案C: 简化架构
- 减少decoder层数（3层）
- 或只监督最后2层辅助损失

## 📈 待验证指标（Epoch 13验证完成后）

- [ ] mAP是否上升（目标>0.5%）
- [ ] 有效预测数是否>0（当前为0）
- [ ] 梯度警告是否减少
- [ ] 辅助损失是否下降

---

**记录时间**: 2026-02-07 17:24
**训练状态**: Epoch 13训练完成，验证进行中
